class WishlistButton{constructor(t){this.customerId=t.customerId,this.productId=t.productId,this.uid=t.uid,this.storeUrl=t.storeUrl,this.currency=t.currency,this.token=window.WishlistUtils.getCookie("jwt"),this.data=t.data,this.icons={heart:'<svg xmlns="http://www.w3.org/2000/svg" width="16px" height="16px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;"><path d="M14 20.408c-.492.308-.903.546-1.192.709-.153.086-.308.17-.463.252h-.002a.75.75 0 01-.686 0 16.709 16.709 0 01-.465-.252 31.147 31.147 0 01-4.803-3.34C3.8 15.572 1 12.331 1 8.513 1 5.052 3.829 2.5 6.736 2.5 9.03 2.5 10.881 3.726 12 5.605 13.12 3.726 14.97 2.5 17.264 2.5 20.17 2.5 23 5.052 23 8.514c0 3.818-2.801 7.06-5.389 9.262A31.146 31.146 0 0114 20.408z"/></svg>',star:'<svg xmlns="http://www.w3.org/2000/svg" width="16px" height="16px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.34 5.82 22 7 14.14l-5-4.87 6.91-1.01L12 2z"/></svg>',plus:'<svg xmlns="http://www.w3.org/2000/svg" width="16px" height="16px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;"><path d="M12 4v16m-8-8h16"/></svg>'},this.checkIcon='<svg xmlns="http://www.w3.org/2000/svg" width="16px" height="16px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;"><path d="M20 6L9 17L4 12"/></svg>',this.button=document.querySelector(".wishlist-button"),this.icon=document.createElement("span"),this.text=document.createElement("span"),document.addEventListener("wishlist:icon-toggled",t=>{t.detail.productId==this.productId&&this.setButtonState(t.detail.isWishlisted)}),this.init()}async init(){this.button?(this.icon.style.marginRight="5px",this.text.style.color=this.data.textColor,this.icon.style.color=this.data.textColor,this.button.style.backgroundColor=this.data.bgColor||"black",this.button.style.color=this.data.textColor||"white",this.button.style.borderRadius=`${this.data.borderRadius}px`||"10px",await this.checkWishlistStatus(),this.button.innerHTML="",this.button.appendChild(this.icon),this.button.appendChild(this.text),this.button.addEventListener("click",()=>this.toggleWishlist())):console.error("Wishlist button not found")}async checkWishlistStatus(){try{const t=await fetch(`/apps/apw/app/apiwishlist?customerId=${this.customerId}&storeUrl=${this.storeUrl}&uid=${this.uid}&token=${this.token||""}&currency=${this.currency}`);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const s=await t.json();s.token&&!this.token&&(this.token=s.token,window.WishlistUtils.setCookie("jwt",this.token,3.5));const e=s.data.includes(this.productId);this.setButtonState(e)}catch(t){console.error("Fetch error:",t)}}async toggleWishlist(){const t=this.text.textContent===this.data.beforeText,s=t?"apiwishlist":"apiremove";this.setButtonState(t);try{const t=await fetch(`/apps/apw/app/${s}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({customerId:this.customerId,productId:this.productId,uid:this.uid,storeUrl:this.storeUrl,token:this.token})}),e=await t.json();document.dispatchEvent(new CustomEvent("wishlist:updated")),window.wishlistIconManager&&window.wishlistIconManager.updateWishlistStatus().then(()=>{window.wishlistIconManager.updateIconsForProduct(this.productId)}),e.token&&!this.token&&(this.token=e.token,window.WishlistUtils.setCookie("jwt",this.token,3.5))}catch(t){console.error(t)}}setButtonState(t){this.text.textContent=t?this.data.afterText:this.data.beforeText,this.icon.innerHTML=t?this.checkIcon:this.icons[this.data.icon]||this.icons.heart,this.icon.style.color=this.data.textColor||"white"}}class WishlistIconManager{constructor({customerId:t,storeUrl:s,uid:e,currency:i}){this.customerId=t,this.storeUrl=s,this.uid=e,this.token=window.WishlistUtils.getCookie("jwt")||"",this.currency=i||"USD",this.wishlistedProducts=new Set,this.settings={iconBefore:"heart",iconAfter:"filled",iconColorBefore:"#000000",iconColorAfter:"#ff0000",defaultSelectors:[".product-card__image-container",".card__media",".grid-product__image-wrap",".product__media-container",".product-image-container",".product__image-wrapper","[data-product-media-container]",".image-container",".card__inner"],customSelectors:[],checkInterval:300,maxChecks:5},this.icons={heart:t=>`<svg xmlns="http://www.w3.org/2000/svg" fill="${t}" viewBox="0 0 24 24"><path d="M14 20.408c-.492.308-.903.546-1.192.709-.153.086-.308.17-.463.252h-.002a.75.75 0 01-.686 0 16.709 16.709 0 01-.465-.252 31.147 31.147 0 01-4.803-3.34C3.8 15.572 1 12.331 1 8.513 1 5.052 3.829 2.5 6.736 2.5 9.03 2.5 10.881 3.726 12 5.605 13.12 3.726 14.97 2.5 17.264 2.5 20.17 2.5 23 5.052 23 8.514c0 3.818-2.801 7.06-5.389 9.262A31.146 31.146 0 0114 20.408z"/></svg>`,filled:t=>`<svg xmlns="http://www.w3.org/2000/svg" fill="${t}" viewBox="0 0 24 24"><path d="M14 20.408c-.492.308-.903.546-1.192.709-.153.086-.308.17-.463.252h-.002a.75.75 0 01-.686 0 16.709 16.709 0 01-.465-.252 31.147 31.147 0 01-4.803-3.34C3.8 15.572 1 12.331 1 8.513 1 5.052 3.829 2.5 6.736 2.5 9.03 2.5 10.881 3.726 12 5.605 13.12 3.726 14.97 2.5 17.264 2.5 20.17 2.5 23 5.052 23 8.514c0 3.818-2.801 7.06-5.389 9.262A31.146 31.146 0 0114 20.408z"/></svg>`},this.productCache=new Map}async fetchSettings(){try{const t=await fetch(`/apps/apw/app/apiicon?storeUrl=${encodeURIComponent(this.storeUrl)}`),s=await t.json();try{const t=JSON.parse(s.reply?.classSelector||"[]");if(Array.isArray(t)){const s=t.map(t=>t.trim()).filter(Boolean);this.settings.customSelectors=Array.from(new Set([...this.settings.customSelectors,...s]))}}catch(t){console.warn("Failed to parse classSelector from backend:",t)}this.applyCustomCSS(s.reply?.customCSS),Object.assign(this.settings,s.reply)}catch(t){console.error("Error loading settings:",t)}}applyCustomCSS(t){if(!t)return;const s=document.getElementById("wishlist-icon-custom-css-api");s&&s.remove();const e=document.createElement("style");e.textContent=t,e.id="wishlist-icon-custom-css-api",document.head.appendChild(e)}async updateWishlistStatus(){try{const t=await fetch(`/apps/apw/app/apiwishlist?customerId=${this.customerId}&storeUrl=${this.storeUrl}&uid=${this.uid}&token=${this.token}&currency=${this.currency}`);if(t.ok){const s=await t.json();s.token&&!this.token&&(this.token=s.token,window.WishlistUtils.setCookie("jwt",this.token,3.5)),this.wishlistedProducts=new Set(s.data||[])}}catch(t){console.error("Error updating wishlist:",t)}}createIcon(t,s){const e=document.createElement("div");return e.className="wishlist-icon",e.innerHTML=t?this.icons[this.settings.iconAfter](this.settings.iconColorAfter):this.icons[this.settings.iconBefore](this.settings.iconColorBefore),e.dataset.productId=s,e}updateIconsForProduct(t){const s=this.wishlistedProducts.has(t);document.querySelectorAll(`.wishlist-icon[data-product-id="${t}"]`).forEach(t=>{t.innerHTML=s?this.icons[this.settings.iconAfter](this.settings.iconColorAfter):this.icons[this.settings.iconBefore](this.settings.iconColorBefore)})}async handleProductCard(t){if(t.dataset.wishlistProcessed||t.classList.contains(this.settings.excludedClass)||t.closest(".wishlist-card"))return;let s=this.settings.customSelectors&&this.settings.customSelectors.length>0?this.settings.customSelectors:this.settings.defaultSelectors,e=null;for(const i of s)if(e=t.querySelector(i)||t.closest(i),e)break;if(e||(e=t.querySelector('[class*="image"], [class*="media"], [class*="card"], [data-product-handle], a[href*="/products/"], .product-card, .grid__item, .card, .card__inner')||t.querySelector("img")?.parentElement||t),!e)return;let i=t.dataset.productId,o=t.dataset.productHandle;if(!o){const s=t.querySelector('a[href*="/products/"]');s&&(o=s.getAttribute("href").split("/products/")[1]?.split(/[?#]/)[0])}if(!i&&o)if(this.productCache.has(o))i=this.productCache.get(o);else try{const t=await fetch(`/products/${o}.js`).then(t=>t.json());i=t.id.toString(),this.productCache.set(o,i)}catch(t){return void console.error("Failed to fetch product data for handle:",o,t)}if(!i)return;if(e.querySelector(".wishlist-icon"))return;const r=this.createIcon(this.wishlistedProducts.has(i),i);"static"===window.getComputedStyle(e).position&&(e.style.position="relative"),r.addEventListener("click",async t=>{t.preventDefault(),t.stopPropagation();const s=this.wishlistedProducts.has(i),e=s?"apiremove":"apiwishlist";try{s?(this.wishlistedProducts.delete(i),r.innerHTML=this.icons[this.settings.iconBefore](this.settings.iconColorBefore)):(this.wishlistedProducts.add(i),r.innerHTML=this.icons[this.settings.iconAfter](this.settings.iconColorAfter)),this.updateIconsForProduct(i);const t=await fetch(`/apps/apw/app/${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({customerId:this.customerId,productId:i,uid:this.uid,storeUrl:this.storeUrl,token:this.token,currency:this.currency})}),o=await t.json();document.dispatchEvent(new CustomEvent("wishlist:updated")),o.token&&!this.token&&(this.token=o.token,window.WishlistUtils.setCookie("jwt",this.token,3.5)),document.dispatchEvent(new CustomEvent("wishlist:icon-toggled",{detail:{productId:i,isWishlisted:!s}}))}catch(t){console.error("Error updating wishlist:",t)}}),e.appendChild(r),t.dataset.wishlistProcessed=!0}processCards(){const t=(this.settings.customSelectors&&this.settings.customSelectors.length>0?this.settings.customSelectors:this.settings.defaultSelectors).join(", "),s=document.querySelectorAll(t);s.forEach(t=>this.handleProductCard(t)),0===s.length&&this.checkCount<this.settings.maxChecks&&(this.checkCount++,setTimeout(()=>this.processCards(),this.settings.checkInterval))}observeMutations(){new MutationObserver(t=>{t.forEach(t=>{t.addedNodes.forEach(t=>{if(1===t.nodeType){const s=(this.settings.customSelectors&&this.settings.customSelectors.length>0?this.settings.customSelectors:this.settings.defaultSelectors).join(", ");(t.matches(s)?[t]:t.querySelectorAll(s)).forEach(t=>this.handleProductCard(t))}})})}).observe(document.body,{childList:!0,subtree:!0})}async init(){this.checkCount=0,await this.fetchSettings(),await this.updateWishlistStatus(),this.processCards(),this.observeMutations()}}